---
title: "Untitled"
format: html
editor: visual
---

## Quarto

Quarto enables you to weave together content and executable code into a finished document. To learn more about Quarto see <https://quarto.org>.

## Running Code

When you click the **Render** button a document will be generated that includes both content and the output of embedded code. You can embed code like this:

```{r}
library(tidyverse)

data <- read.csv(file = "intermediate_data/summary_current.csv", header = T)
getwd()
treemap_data <- data %>%
  pivot_longer(cols = Least.Concern:Extinct, names_to = "status", values_to = "count") %>%
  select(current_knowledge, status,genus, count) %>%
  subset(count != 0) %>%
  filter(!(status %in% c("Extinct", "Lower.Risk.conservation.dependent", "Lower.Risk.near.threatened", "Data.Deficient")))

unique(treemap_data$status)
# Assuming treemap_data is your data frame containing the 'status' and 'current_knowledge' columns
treemap_data <- treemap_data %>%
  mutate(status = recode(status,
                         "Least.Concern" = "Least Concern",
                         "Critically.Endangered" = "Critically Endangered",
                         "Near.Threatened" = "Near Threatened")) %>%
  mutate(current_knowledge = recode(current_knowledge,
                                    "non-endemic" = "Non-Endemic",
                                    "endemic" = "Endemic"))



```

You can add options to executable code like this

```{r}
# Create a nested list with the desired structure
nested_list <- split(treemap_data, treemap_data$current_knowledge)

# For each level one element (current_knowledge), split by status and create a named list
nested_list <- lapply(nested_list, function(sub_df) {
  status_list <- split(sub_df, sub_df$status)
  
  # For each status, create a named list with genus as names and count as values
  status_list <- lapply(status_list, function(status_df) {
    genus_list <- as.list(status_df$count)
    names(genus_list) <- status_df$genus
    genus_list
  })
  
  status_list
})

```

The `echo: false` option disables the printing of code (only output is displayed).

```{r}
# | echo: false
library(RColorBrewer)
library(highcharter)
# Process data to create hierarchical structure for treemap
points <- list()
regionI <- 0

my_colors <- brewer.pal(9, "Set1")

for (endemicity in names(nested_list)) {
  regionVal <- 0
  regionP <- list(
    id = paste0("id_", regionI),
    name = endemicity,
    color = my_colors[regionI + 1]
  )
  
  countryI <- 0
  for (status in names(nested_list[[endemicity]])) {
    countryP <- list(
      id = paste0(regionP$id, "_", countryI),
      name = status,
      parent = regionP$id
    )
    points[[length(points) + 1]] <- countryP
    
    causeI <- 0
    for (genera in names(nested_list[[endemicity]][[status]])) {
      causeP <- list(
        id = paste0(countryP$id, "_", causeI),
        name = genera,
        parent = countryP$id,
        value = round(as.numeric(nested_list[[endemicity]][[status]][[genera]]))
      )
      regionVal <- regionVal + causeP$value
      points[[length(points) + 1]] <- causeP
      causeI <- causeI + 1
    }
    countryI <- countryI + 1
  }
  
  regionP$value <- round(regionVal / countryI)
  points[[length(points) + 1]] <- regionP
  regionI <- regionI + 1
}

# Create the treemap chart using highcharter
treemap <- highchart() %>%
  hc_chart(type = "treemap") %>%
  hc_add_series(
    type = "treemap",
    name = "Regions",
    layoutAlgorithm = "squarified",
    allowDrillToNode = TRUE,
    animationLimit = 1000,
    dataLabels = list(
      enabled = FALSE
    ),
    levels = list(
      list(
        level = 1,
        dataLabels = list(
          enabled = TRUE,
          style = list(fontSize = "14px")
        ),
        borderWidth = 3,
        borderColor = "black",  # Set the border color here (white in this example)
        levelIsConstant = FALSE
      )
    ),
    accessibility = list(exposeAsGroupOnly = TRUE),
    data = points
  ) %>%
  hc_subtitle(
    text = 'Click points to drill down. Source: IUCN Redlist',
    align = 'left'
  ) %>%
  hc_title(
    text = 'Threatened Species Status per Endemicity in Australia',
    align = 'left'
  )

treemap
```

```{r}
library(htmlwidgets)

saveWidget(treemap, file = "treemap.html")
```
